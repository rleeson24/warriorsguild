@model WarriorsGuild.Models.RanksUrls
@{
	ViewBag.Title = "Ranks | Warriors Guild";
	var UserIsAdmin = User.IsInRole("Admin");
	var UserIsAdminString = UserIsAdmin.ToString().ToLower();
	var UserIsGuardian = User.IsInRole("Guardian");
	var UserIsGuardianString = UserIsGuardian.ToString().ToLower();
	var UserIsWarrior = User.IsInRole("Warrior");
	var UserIsWarriorString = UserIsWarrior.ToString().ToLower();
	var ringTypesJsonArrayString = Json.Serialize(Enum.GetNames(typeof(RingType))
										.Select(e => new { value = e, description = e }).ToArray());
}

@using WarriorsGuild.Data.Models.Rings
@using WarriorsGuild.Utilities
@inject WarriorsGuild.Helpers.Utilities.ISessionManager SessionManager
<!-- ko with: ranks -->
<div class="container text-center" id="goal-grid">
	<div class="row" data-bind="visible: !DetailView()">
		@if (UserIsAdmin && !SessionManager.PreviewMode)
		{
			<div data-bind="sortable: { data: dataModel.Ranks, as: 'rank', afterMove: saveNewRankOrder }">
				<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3" data-bind="template: { data: rank, name: 'admin-rank-template' }"></div>
			</div>
			<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3" data-bind="template: { name: 'add-rank-template' }"></div>
		}
		@if (!UserIsAdmin || SessionManager.PreviewMode)
		{ 
			<div data-bind="visible: dataModel.Ranks().length === 0" class="col-xs-12 center" style="display:none">
				<h3 style="margin-bottom: 200px;">No Ranks were found in the system.  Please contact administrator.</h3>
			</div>
			<!-- ko foreach: { data: dataModel.Ranks, as: 'rank' } -->
			<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3" data-bind="template: { data: rank, name: 'rank-template' }"></div>


			<!-- Add the extra clearfix for only the required viewport -->
			<!-- ko if: ( $index() + 1 ) % 2 === 0 -->
			<div class="clearfix visible-sm-block hidden-md hidden-lg"></div>
			<!-- /ko -->
			<!-- ko if: ( $index() + 1 ) % 4 === 0 -->
			<div class="clearfix visible-md-block visible-lg-block"></div>
			<!-- /ko -->
			<!-- /ko -->
		}
	</div>
	<div data-bind="visible: DetailView()" style="display:none" class="goal-detail">
		<!-- ko with: rankDetail -->
		<div class="row text-center">
			<div class="col-xs-12">
				<h1 data-bind="text: name()"></h1>
			</div>
		</div>
		<div class="row">
			<div class="col-xs-12 col-sm-offset-4 col-sm-4">
				<div class="image-upload">
					<img data-bind="attr:{ src: imgSrcAttr() }, visible: hasImage()" alt="goal-image" style="width:100%">
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-xs-12">
				<p data-bind="text: description()">
				</p>
			</div>
		</div>

		@if (User.Identity.IsAuthenticated)
		{
			<div class="row">
				@if (UserIsAdmin && !SessionManager.PreviewMode)
				{
					<div class="col-xs-12">
						<div class="btn btn-sm btn-info documentationUpload">
							<form data-bind="imageUploader: { key: 'Guide',
														id: id(),
														postUrl: rankUrls.uploadGuideUrl + '/' + id(),
														imgUrl: rankUrls.downloadGuideUrl + '/' + id(),
														fileClass: 'pdf',
														successCallBack: function() { $data.guideUploaded(new Date()); } }" action="" method="post" enctype="multipart/form-data">
								<div style="overflow: hidden;">
									<span class="glyphicon glyphicon-upload"></span><span> Upload Documentation</span>
									<input type="file" data-bind="uniqueName: true" />
								</div>
							</form>
						</div>
					</div>
				}
			</div>
			@if (!UserIsWarrior)
			{
				<div class="row">
					<div class="col-xs-12" data-bind="visible: $data.hasGuide()">
						<a data-bind="attr: { href: rankUrls.downloadGuideUrl + '/' + id() }" download>Download the Guide <img src="~/images/download.png" style="width:22px" /></a>
					</div>
				</div>
			}
			<div class="container">
				<div class="row"><h3>Requirements</h3></div>

				@if (UserIsAdmin && !SessionManager.PreviewMode)
				{
					<p class="col-xs-12">Rearrange items by drag-and-drop</p>
					<div class="row" data-bind="sortable: requirements" id="requirementsList">
						<div class="col-xs-12 col-sm-12 col-md-offset-1 col-md-9 text-left editable-requirement">
							<div class="row">
								<div class="col-xs-1">
									<span data-bind="text: $index() + 1"></span>
								</div>
								<div class="col-xs-11">
									<div style="position: relative;">
										<textarea class="form-control" data-bind="value: actionToComplete"></textarea>
										<span>See How Link: </span><input type="text" class="form-control" data-bind="value: seeHowLink" /><span class="text-danger" data-bind="visible: seeHowLinkInvalid()">Invalid See How Url</span>
										<div class="btn-group wg-btn-remove-grp">
											<button type="button" class="btn btn-xs btn-default wg-btn-remove" style="padding-top: 4px;" data-bind="click: function() { $parent.requirements.remove($data); }"><span class="glyphicon glyphicon-trash"></span></button>
										</div>
									</div>
								</div>
								<div class="col-xs-1"></div>
								<div class="form-group">
									<label class="col-xs-2 col-sm-1 col-form-label" style="padding-top: 5px" for="inputWeight">Weight:</label>
									<div class="col-xs-3 col-sm-2"><input type="number" class="form-control" id="inputWeight" inputmode="numeric" maxlength="3" data-bind="value: weight" min="1" max="50" /></div>
								</div>
								<div class="col-xs-4 col-sm-6 text-left">
									<div class="col-xs-12">
										<custom-checkbox params="{id: 'rqChkInitiatedByGuardian' + $index(),
                                                        text: 'Initiated By Guardian',
                                                        checked: initiatedByGuardian,
														data: $data
                                                        }">
															<div data-bind="visible: initiatedByGuardian()">
																<label>At Percent: </label>
																<input type="number" class="form-control" style="width:50px; display: inline-block;" inputmode="numeric" data-bind="value: showAtPercent" min="0" max="100" />
															</div>
														</custom-checkbox>
									</div>
									<div class="col-xs-12">
										<custom-checkbox params="{id: 'rqChkOptional' + $index(),
                                                        text: 'Optional',
                                                        checked: optional,
														data: $data
                                                        }"></custom-checkbox>
									</div>
									<div class="col-xs-12">
										<custom-checkbox params="{id: 'rqChkRequireAttachment' + $index(),
                                                        text: 'Require Attachment',
                                                        checked: requireAttachment,
														data: $data
                                                        }"></custom-checkbox>
									</div>
									@*<div class="col-xs-12">
										<div class="check">
											<div class="squaredThree">
												<input type="checkbox" data-bind="attr: { id: 'rqChkRequireRing' + $index() },
																	checked: requireRing" />
												<label data-bind="attr: { for: 'rqChkRequireRing' + $index() }"></label>
											</div>
										</div>
										<label data-bind="attr: { for: 'rqChkRequireRing' + $index() }">Require Ring</label>
										<div data-bind="visible: requireRing()" class="rankAdditionalRingRequirements">
											<select class="form-control" style="width:100px; display: inline-block;" data-bind="attr: { id: 'rqDdlRingType' + $index() }, value: requiredRingType, options: $parents[1].dataModel.ringTypes, optionsText: 'description', optionsValue: 'value', optionsCaption: 'Type...'"></select>
											<label>Count: </label>
											<input type="number" class="form-control" style="width:50px; display: inline-block;" inputmode="numeric" data-bind="value: requiredRingCount" min="0" max="5" />
										</div>
									</div>*@
									<div class="col-xs-12">
										<custom-checkbox params="{id: 'rqChkRequireCross' + $index(),
														text: 'Require Cross',
                                                        checked: requireCross,
														data: [ $data, $index(), $parents[1].dataModel.crossOptions() ]
                                                        }">
														<div data-bind="visible: $data[0].requireCross()">
															<!-- ko if: $data[0].crossesToComplete().length > 0 -->
															<div class="rankAdditionalRingRequirements">
																<label>Crosses:</label>
																<!-- ko foreach: $data[0].crossesToComplete -->
																<select class="form-control" style="width:100px; display: inline-block;" data-bind="attr: { id: 'rqDdlCross' + $parent[1] }, value: crossId, options: $parent[2].concat( $data ? new Array($data) : new Array(0)), optionsText: 'name', optionsValue: 'crossId', optionsCaption: 'Choose...'"></select>
																<!-- /ko -->
															</div>
															<!-- /ko -->
														</div>
										</custom-checkbox>										
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-xs-12">
							<button class="btn btn-xs btn-addnew" data-bind="click: addRequirement"><span class="glyphicon glyphicon-plus-sign"></span>&nbsp;Add New Requirement</button>
						</div>
					</div>
					<div class="row">
						<div class="col-xs-12">
							<button class="btn btn-sm btn-primary" data-bind="click: $parent.updateRequirements">Save Changes</button>
						</div>
					</div>
				}
				@if (!UserIsAdmin || SessionManager.PreviewMode)
				{
					<div class="row" data-bind="visible: completedPercent() == 100 && !guardianApproved()">
						<h2 class="col-xs-12">It's time for a Round Table!!</h2>
					</div>
					<div class="row" data-bind="foreach: requirements">
						<div class="col-xs-12 col-sm-12 col-md-offset-2 col-md-8 col-lg-offset-3 col-lg-6 text-left col-requirement">
							<div class="check">
								<div class="squaredThree" data-bind="css: { completed: guardianReviewed(), triggerAttachment: (requireAttachment() && !lockEntry) }">

									@if (!ViewBag.HasActiveSubscription)
									{
										<div data-bind="attr: { id: 'rq' + $index() }"></div>
									}
									else
									{
										<!-- ko if: !requireAttachment() || warriorCompleted() -->
										<input type="checkbox" data-bind="enable: @UserIsWarriorString && !guardianReviewed() && !$parent.pendingApproval(),
																	attr: { id: 'rq' + $index(), alt: completionSummaryText(), css: { completed: guardianReviewed() } },
																	checked: warriorCompleted(),
																	click: (!warriorCompleted() && @UserIsWarriorString) ? markAsComplete : (!guardianReviewed() && !$parent.pendingApproval()) ? revertCompletion : function() {}" />
										<!-- /ko -->
										<!-- ko if: requireAttachment() && !warriorCompleted() -->
										<input type="checkbox" data-bind="enable: @UserIsWarriorString && !guardianReviewed() && !$parent.pendingApproval(),
																	attr: { id: 'rq' + $index(), alt: completionSummaryText(), css: { completed: guardianReviewed() } },
																	checked: warriorCompleted()" />
										<!-- /ko -->
									}
									<label data-bind="attr: { for: 'rq' + $index(), title: completionSummaryText() }"></label>
									<!-- ko if: requireAttachment() && !warriorCompleted() -->
									<form data-bind="imageUploader: { key: 'POC' + id,
													id: id,
													postUrl: rankUrls.proofOfCompletionUrl,
													fileClass: 'any',
													maxSize: 5000000,
													successCallBack: function( respData ) { $data.addAttachment( respData ); $data.warriorCompletedTs(new Date()); } }, uniqueName: true" action="" method="post" enctype="multipart/form-data">
										<input type="hidden" data-bind="attr: { name: 'reqId' + $index() }, textInput: id" />
										<input type="hidden" data-bind="attr: { name: 'rankId' + $index() }, textInput: $parents[1].rankDetail.id()" />
										<input type="file" data-bind="uniqueName: true" multiple />
									</form>
									<!-- /ko -->
								</div>
							</div>
							<span class="actionToComplete" data-bind="html: actionToCompleteLinked, css: { outOfReach: @UserIsWarriorString && !warriorCompleted() && ($parent.requestPromotionEnabled() || $parent.pendingApproval()) }"></span>
						</div>
						<!-- ko if: isLoggedIn -->
						<!-- ko if: (requiredRingType() === 'Silver' && $parents[1].dataModel.silverRingOptions().length > 0) || requiredRingType() === 'Gold' && $parents[1].dataModel.goldRingOptions().length > 0 || requiredRingType() === 'Platinum' && $parents[1].dataModel.platinumRingOptions().length > 0 -->
						<div class="col-xs-12 col-sm-12 col-md-offset-2 col-md-8" data-bind="visible: requireRing() && !warriorCompleted()">
							<div class="rankAdditionalRingRequirements">
								<label>Rings:</label>
								<!-- ko foreach: selectedRings -->
								<!-- ko if: $parent.requiredRingType() === 'Silver' && $parents[2].dataModel.silverRingOptions().length > 0 -->
								<select class="form-control" style="width:100px; display: inline-block;" data-bind="attr: { id: 'rqDdlRing' + $index() }, value: ringId, options: $parents[2].dataModel.silverRingOptions(), optionsText: 'name', optionsValue: 'ringId', optionsCaption: 'Choose...'"></select>
								<!-- /ko -->
								<!-- ko if: $parent.requiredRingType() === 'Gold' && $parents[2].dataModel.goldRingOptions().length > 0 -->
								<select class="form-control" style="width:100px; display: inline-block;" data-bind="attr: { id: 'rqDdlRing' + $index() }, value: ringId, options: $parents[2].dataModel.goldRingOptions(), optionsText: 'name', optionsValue: 'ringId', optionsCaption: 'Choose...'"></select>
								<!-- /ko -->
								<!-- ko if: $parent.requiredRingType() === 'Platinum' && $parents[2].dataModel.platinumRingOptions().length > 0 -->
								<select class="form-control" style="width:100px; display: inline-block;" data-bind="attr: { id: 'rqDdlRing' + $index() }, value: ringId, options: $parents[2].dataModel.platinumRingOptions(), optionsText: 'name', optionsValue: 'ringId', optionsCaption: 'Choose...'"></select>
								<!-- /ko -->
								<!-- /ko -->
							</div>
						</div>
						<!-- /ko -->
						<div class="col-xs-12 col-sm-12 col-md-offset-2 col-md-8" data-bind="visible: requireCross() && !warriorCompleted()">
							@if (UserIsWarrior)
							{
								<!-- ko if: $parents[1].dataModel.crossOptions().length > 0 -->
								<div class="rankAdditionalRingRequirements">
									<label>Crosses:</label>
									<!-- ko foreach: selectedCrosses -->
									<select class="form-control" style="width:100px; display: inline-block;" data-bind="attr: { id: 'rqDdlCross' + $index() }, value: crossId, options: $parents[2].dataModel.crossOptions(), optionsText: 'name', optionsValue: 'crossId', optionsCaption: 'Choose...'"></select>
									<!-- /ko -->
								</div>
								<!-- /ko -->
							}
						</div>
						<div class="col-xs-12 col-sm-12 col-md-offset-2 col-md-8" data-bind="visible: requireCross() && warriorCompleted()">
							<div class="rankAdditionalRingRequirements">
								<label>Crosses:</label>
								<!-- ko foreach: savedCrosses -->
								<img style="height:40px" data-bind="attr: { src: imgSrcAttr, alt: name, title: name }" />
								<!-- /ko -->
							</div>
						</div>
						<div class="col-xs-12 col-sm-12 col-md-offset-2 col-md-8" data-bind="visible: requireRing() && warriorCompleted()">
							<div class="rankAdditionalRingRequirements">
								<label>Rings:</label>
								<!-- ko foreach: savedRings -->
								<img style="height:40px" data-bind="attr: { src: imgSrcAttr, alt: name, title: name }" />
								<!-- /ko -->
							</div>
						</div>
						<div class="col-xs-12 col-sm-12 col-md-offset-2 col-md-8" data-bind="visible: requireAttachment() && warriorCompleted()">
							<div class="rankAdditionalRingRequirements">
								<label>Attachments:</label>
								<!-- ko foreach: attachments -->
								<a data-bind="click: $parents[2].downloadProofOfCompletionFile" style="cursor: pointer" class="btn btn-sm btn-info">
									<span data-bind="text:$index() + 1"></span>
								</a>
								<!-- /ko -->
							</div>
						</div>
						<!-- /ko -->
					</div>
				}
				<!-- ko if: !(highestPercentSubmittedForApproval() == 100 && guardianApproved() && (!@UserIsAdminString || $parent.PreviewMode())) -->
				@if (UserIsWarrior)
				{
					<div class="row">
						<div class="col-xs-12">
							<!-- ko if: returnReason() -->
								<div class="return-reason-label">Message from Guardian: </div><div data-bind="text: returnReason()"></div>
							<!-- /ko -->
							<button class="btn btn-sm btn-success" data-bind="click: function(data) { $parent.beginRequestForPromotion(data); }, visible: requestPromotionEnabled(), text: completedPercent() < 100 ? 'Submit for Promotion' : 'Request Round Table'"></button>
							<button class="btn btn-sm btn-danger" data-bind="click: function(data) { $parent.recallRequestForPromotion(data); }, visible: completedPercent() > 0 && warriorCompleted() && pendingApproval(), text: 'Recall Request for ' + (completedPercent() < 100 ? 'Promotion' : 'Round Table')">Recall Request for Promotion</button>
						</div>
					</div>
				}
				@if (UserIsGuardian || SessionManager.PreviewMode)
				{
					<div class="row">
						<div class="col-xs-12">
							<button class="btn btn-sm btn-primary" data-bind="click: function(data) { $parent.confirmRankCompletion(data); }, visible: warriorCompleted() && pendingApproval(), text: completedPercent() < 100 ? 'Promote' : 'Complete Round Table and Promote'"></button>
							<button class="btn btn-sm btn-danger" data-bind="click: function(data) { $parent.returnRank( data ); }, visible: warriorCompleted() && pendingApproval()">Return to Warrior</button>
						</div>
					</div>
				}
				<!-- /ko -->
				<!-- ko if: highestPercentSubmittedForApproval() == 100 && guardianApproved() && (!@UserIsAdminString || $parent.PreviewMode()) -->
				<div class="row">
					<div class="col-xs-12">
						<h3>Completed and Confirmed!</h3>
					</div>
				</div>
				<!-- /ko -->
			</div>
		}
		<!-- /ko -->
	</div>
</div>

<partial name="~/Views/Ranks/ReturnReasonDialog.cshtml" />
<!-- /ko -->

@if (UserIsAdmin)
{
	<script type="text/html" id="admin-rank-template">
		<div class="goal-grid-item">

			<!--rank Name-->
			<div class="goal-name">
				<input type="text" class="form-control" placeholder="Name" data-bind="value: name">
			</div>
			<!--rank Name-->
			<!--rank Image-->
			<div class="goal-image image-upload">
				<a href="#detail" data-bind="attr: { href: '#detail?id=' + id() }">
					<img data-bind="attr:{ src: imgSrcAttr() }, visible: hasImage()" alt="goal-image" class="img-responsive">
					<img src="/images/logo/Warriors-Guild-icon-sm.png" alt="goal-image" class="img-placeholder" data-bind="visible: !hasImage()">
				</a>
				<div class="imgUpload">
					<form data-bind="imageUploader: { key: $index(), id: id(), postUrl: rankUrls.imageUploadBaseUrl + '/' + id(), imgUrl: rankUrls.imageBaseUrl + '/' + id(), fileClass: 'image', maxSize: 200000, successCallBack: function() { $data.imageUploaded(new Date()); } }" action="" method="post" enctype="multipart/form-data">
						<div style="position: relative; overflow: hidden;">
							<h4 data-bind="text: 'Upload Image'"></h4>
							<input type="file" data-bind="uniqueName: true" />
						</div>
					</form>
				</div>
				@*<div class="price">
						<h4>$123</h4>
					</div>*@
			</div>
			<!--rank Image-->
			<!--rank Detail-->
			<div class="goal-detail">

				@*<div class="days-strength">
						<div class="row">

							<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
								<span><i class="fa fa-clock-o"></i></span><p>7 Days</p>
							</div>

							<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
								<span><i class="fa fa-users"></i></span><p>25</p>
							</div>

						</div>
					</div>*@

				<textarea class="form-control" placeholder="Description" data-bind="value: description"></textarea>
			</div>
			<button style="width: 100%; height: 100%" data-bind="click: function(data) { $parents[1].updateRank(data, $parents[1].dataModel.RanksUrl); }">
				<span data-bind="text: 'Save'"></span>
			</button>
			<!--rank Detail-->

		</div>
	</script>


	<script type="text/html" id="add-rank-template">
		<div class="goal-grid-item">

			<!--rank Name-->
			<div class="goal-name">
				<input type="text" class="form-control" placeholder="Name" data-bind="value: dataModel.Name">
			</div>
			<!--rank Name-->
			<!--rank Image-->
			<div class="goal-image image-upload">
				@*<div class="price">
						<h4>$123</h4>
					</div>*@
			</div>
			<!--rank Image-->
			<!--rank Detail-->
			<div class="goal-detail">

				@*<div class="days-strength">
						<div class="row">

							<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
								<span><i class="fa fa-clock-o"></i></span><p>7 Days</p>
							</div>

							<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
								<span><i class="fa fa-users"></i></span><p>25</p>
							</div>

						</div>
					</div>*@

				<textarea class="form-control" placeholder="Description" data-bind="value: dataModel.Description"></textarea>
			</div>
			<button style="position: relative; overflow: hidden; width: 100%; height: 100%" data-bind="click: saveRank">
				<span data-bind="text: 'Save'"></span>
			</button>
			<!--rank Detail-->

		</div>
	</script>
}

<script type="text/html" id="rank-template">
	<div class="goal-grid-item">

		<!--rank Name-->
		<div class="goal-name">
			<a data-bind="attr: { href: '#detail?id=' + id() }">
				<h4 data-bind="text: name()"></h4>
			</a>
		</div>
		<!--rank Name-->
		<!--rank Image-->
		<div class="goal-image">
			<a href="#detail" data-bind="attr: { href: '#detail?id=' + id() }">
				<img data-bind="attr:{ src: imgSrcAttr() }, visible: hasImage()" alt="goal-image" class="img-responsive">
				<img src="/images/logo/Warriors-Guild-icon-sm.png" alt="goal-image" class="img-placeholder" data-bind="visible: !hasImage()">
			</a>
			@*<div class="price">

				</div>*@
		</div>
		<!--rank Image-->
		<!--rank Detail-->
		<div class="goal-detail">

			@*<div class="days-strength">
					<div class="row">

						<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
							<span><i class="fa fa-clock-o"></i></span><p>7 Days</p>
						</div>

						<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
							<span><i class="fa fa-users"></i></span><p>25</p>
						</div>

					</div>
				</div>

				<div class="rating">
					<span><i class="fa fa-star"></i></span>
					<span><i class="fa fa-star"></i></span>
					<span><i class="fa fa-star"></i></span>
					<span><i class="fa fa-star"></i></span>
				</div>*@

			<p data-bind="text: description()"></p>
			@*<h4 class="instructor-name"><span><i class="fa fa-graduation-cap"></i></span>What goes here?</h4>*@
		</div>
		<!--rank Detail-->

	</div>
</script>

<script>
	var rankUrls = @Html.Raw(Json.Serialize(Model));
	var isLoggedIn = @User.Identity.IsAuthenticated.ToString().ToLower();
	var canViewAll = isLoggedIn && @((UserIsAdmin || ViewBag.HasActiveSubscription ).ToString().ToLower());
	var userIsWarrior = @UserIsWarriorString;
	var ringTypes = @Html.Raw(@ringTypesJsonArrayString);
</script>

@section Styles {
	<link href="@Url.ContentVersioned("~/bundles/jquery-ui.css")" rel="stylesheet" />
}
@section Scripts{
	<script src="@Url.ContentVersioned("/bundles/knockout.js")" defer></script>
	<script src="@Url.ContentVersioned("/bundles/ranks.js")" defer></script>
	<script type="text/javascript">
		$(document).ready(function () {
			$("#returnReasonDialog").dialog({ autoOpen: false, modal: true, title: "Return" });
		});
	</script>
}
